<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <meta content="utf-8"/>
    <title>${form.dashboard.title}</title>
    <link rel="stylesheet" href="${service.context}/webjars/bootstrap/${webjars.bootstrap.version}/css/bootstrap.css" />
    <link rel="stylesheet" href="${service.context}/webjars/${the.template.library}/${project.version}/css/provtemplate.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="${service.context}/webjars/font-awesome/${webjars.fontawesome.version}/css/font-awesome.min.css"/>

    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>


<body>
<script src="${service.context}/webjars/jquery/${webjars.jquery.version}/jquery.min.js"></script>
<script src="${service.context}/webjars/datatables.net/${webjars.datatables.version}/js/jquery.dataTables.min.js" type="text/javascript" charset="utf8" ></script>
<script src="${service.context}/webjars/JSV/lib/jsv.js"></script>
<script src="${service.context}/webjars/underscore/${webjars.underscore.version}/underscore.js"></script>
<script src="${service.context}/webjars/jsonform/lib/jsonform.js"></script>
<script src="${service.context}/webjars/jsonform/deps/opt/jquery-ui.js"></script>
<script src="${service.context}/webjars/jquery-csv/${webjars.jquery.csv.version}/src/jquery.csv.js"></script>


<script src="${service.context}/webjars/j4ts/${webjars.j4ts.version}/bundle.js"></script>


<script src="${service.context}/webjars/${the.template.library}/${project.version}/js/bundle.js"></script>
<script src="${service.context}/webjars/${the.template.library}/${project.version}/js/TemplateManager.js"></script>

<style>
    .container {
        min-width:1200px;
        width: auto !important;
        width:1500px;
    }
    .shared_var {
        color: blue;
    }
</style>

<div class="container">
    <div class="row header">
        <div class="col-lg-12 text-left">
            <h3>${form.dashboard.title}</h3>
        </div>
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a href="#tab_compose" data-toggle="pill" class="nav-link show active" role="tab" id="composer-lnk">Composer</a>
            </li>
            <li class="nav-item">
                <a href="#tab_documentation" data-toggle="pill" class="nav-link" role="tab">Documentation</a>
            </li>
            <li class="nav-item">
                <a href="#tab_csv_log" data-toggle="pill" class="nav-link" role="tab">CSV Logger</a>
            </li>
            <li class="nav-item">
                <a href="#tab_browser" data-toggle="pill" class="nav-link" role="tab">Browser</a>
            </li>
            <li class="nav-item">
                <a href="#tab_navigator" data-toggle="pill" class="nav-link" role="tab">Navigator</a>
            </li>


        </ul>

        <div class="tab-content" id="all-tab-contents">
            <div id="tab_compose" class="tab-pane active" role="tabpanel">
                <div class="col-lg-2">
                    <div id="template-dropdown-composer">
                        <a href="#" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" id="template-dropdown-composer-lnk">PLEAD Templates</a>
                    </div>
                </div>
                <div class="col-lg-4 first-column">
                    <div id="template-form">
                        <form></form>
                    </div>
                </div>
                <div class="col-sm-3">
                    <h4>CSV encoding</h4>
                    <pre id="csv_result"><p> </p></pre>
                    <p> </p>
                    <h4>JSON encoding</h4>
                    <pre id="json_result" class="pretty">
                    </pre>
                </div>
                <div class="col-sm-3">
                    <button id="button-submit-json" type="button" class="btn btn-warning" onclick="submitEnactor(true)">Submit (json)</button>
                    <button id="button-submit-csv" type="button" class="btn btn-warning" onclick="submitEnactor(false)">Submit (csv)</button>
                    <button id="button-clear" type="button" class="btn btn-info" onclick="enactClear()">Clear</button>
                    <h4>Submission Result</h4>
                    <pre id="enact_result" class="pretty"> </pre>
                    <p id="prov_link"></p>
                </div>
            </div>

            <div id="tab_documentation" class="tab-pane" role="tabpanel">
                <div class="col-lg-2">
                    <div id="template-dropdown-documentation">
                        <a href="#" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">PLEAD Templates</a>
                    </div>
                </div>
                <div class="col-lg-7 first-column">
                    <div id="documentation">
                    </div>
                    <div id="documentation_image">
                    </div>
                    <div id="tmp_div" class="invisible_div">
                    </div>
                </div>
            </div>


            <div id="tab_csv_log" class="tab-pane" role="tabpanel">
                <pre id="csv_log"></pre>
            </div>

            <div id="tab_browser" class="tab-pane" role="tabpanel">
                <div class="col-lg-1">
                    <button id="browser-refresh" type="button" class="btn btn-info" onclick="submitBrowse(true)">Refresh</button>
                </div>
                <div class="col-lg-11 first-column">
                    <table id="browser_list"
                           class="display"
                           style="width:80%">

                    </table>
                </div>
            </div>

            <div id="tab_navigator" class="tab-pane" role="tabpanel">
                <pre id="navigator">To come soon</pre>
            </div>
        </div>
    </div>
</div>

<script>
    function diff (arr1, arr2) {
        return arr1.filter(x => !arr2.includes(x));
    }

    function constructMenusConfiguration() {
        let profile = {}
        for (var indx in builders) {
            const builder = builders[indx]
            let name = builder.getName()
            if (typeof builder.getCompulsoryInputs !== "undefined") { //not selecting composite
                let compusolryFields = ["isA"].concat(builder.getCompulsoryInputs());
                let optionalFields = diff(builder.getInputs(), builder.getCompulsoryInputs());
                profile[name] = {
                    compulsory: compusolryFields,
                    optional: optionalFields
                }
            } else {
                console.log("composite " + name)
                profile[name] = {
                    compulsory: ["isA","__elements"],
                    optional: diff(builder.getPropertyOrder(), ["isA"])
                }
                profile[name].compulsory=profile[name].compulsory.concat(profile["plead_transforming"].compulsory.map(x => ["__element", x]));
            }
        }
        //console.log(profile)
        return profile;
    }



    const MEDIA_TYPE_APPLICATION_PROV_TEMPLATE_JSON = "application/vnd.kcl.prov-template+json";
    const MEDIA_TYPE_TEXT_CSV = "text/csv";

    const HTML_ANCHOR_ENACT_RESULT_BOX = '#enact_result';
    const HTML_ANCHOR_JSON_RESULT = '#json_result';
    const HTML_ANCHOR_CSV_RESULT = '#csv_result';
    const HTML_ANCHOR_CSV_LOG = '#csv_log';
    const HTML_ANCHOR_ENACT_RESULT_PROV_LINK = '#prov_link';
    const HTML_ANCHOR_DOCUMENTATION_IMAGE = '#documentation_image';
    const HTML_ANCHOR_TEMPLATE_DROPDOWN_COMPOSER = "#template-dropdown-composer";
    const HTML_ANCHOR_TEMPLATE_DROPDOWN_DOCUMENTATOIN = "#template-dropdown-documentation";

    const SUBMISSION_URL = '${service.context}/provapi/statements/';
    const SCHEMA_URL = "${service.context}/webjars/${the.template.library}/${project.version}/schema/schema${the.template.sublibrary}.json";
    const DOC_URL = "${service.context}/webjars/${the.template.library}/${project.version}/html/doc${the.template.sublibrary}.html";

    const logger=new org.openprovenance.prov.template.library.plead.logger.Logger();
    const builders=logger.getBuilders()
    const profile = constructMenusConfiguration();

    console.log(profile)


    function submitEnactor(jsonSubmit) {
        $(HTML_ANCHOR_ENACT_RESULT_BOX).html($('<p>'));
        $(HTML_ANCHOR_ENACT_RESULT_BOX).attr('received','false');
        submitService(jsonSubmit, SUBMISSION_URL, HTML_ANCHOR_ENACT_RESULT_BOX, HTML_ANCHOR_CSV_LOG, HTML_ANCHOR_ENACT_RESULT_PROV_LINK, true,true)
    }



    var alreadySeen=[]

    function createProvLink(name, ID) {
        return "Link to Provenance <a target='_blank' href='${service.context}/provapi/template/" + name + "/" + ID + ".svg'   >(svg)</a>,"
                               + " <a target='_blank' href='${service.context}/provapi/template/" + name + "/" + ID + ".provn' >(provn)</a>,"
                               + " <a target='_blank' href='${service.context}/provapi/template/" + name + "/" + ID + ".jsonld'>(jsonld)</a>";
    }

    function submitService(jsonSubmit, url, anchor_result_box, anchor_csv, anchor_result_prov_link, enactorp, allRecordsp) {
        console.log("submitService")

        let csv_data=$(HTML_ANCHOR_CSV_RESULT).text()
        const input_bean = tm.getBean();
        const __elements=input_bean.__elements;
        let json_data=JSON.stringify(alreadySeen.concat([input_bean]))
        if (allRecordsp) alreadySeen=[]
        console.log("submitService " + json_data);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.onerror= function(xhr,event) {
            console.log("error with " + event);
            $(anchor_result_box).html("error with " + event);

        };
        xhr.onabort= function(xhr,event) {
            console.log("abort with " + event);
            $(anchor_result_box).html("abort with " + event);
        };
        xhr.onload= function() {
            console.log("loaded " + xhr.status);
            if (xhr.status === 400 || xhr.status === 404) {
                $(anchor_result_box).html("status code " + xhr.status + " " + xhr.responseText);
            } else if (!enactorp && (xhr.status === 200)) {
                $(anchor_result_box).html('<i class="fa fa-check"></i>' + "Passed Validator!");
            } else {
                const parsed = JSON.parse(xhr.responseText);
                let name=parsed[0]["isA"];
                if (__elements) {
                    // this is a compositive bean, get the type from the input bean
                    parsed[0].type=input_bean.type;
                }
                let highlighted=tm.syntaxHighlight_json(JSON.stringify(parsed, null, 2), name)
                $(anchor_result_box).html(highlighted);
                if (anchor_csv) {
                    let merged= {...input_bean, ...parsed[0]}
                    let csv_bean=tm.populateBean(name, merged)
                    // if we want json log
                    //      $(id2).append(JSON.stringify(merged, null, 2));
                    // if we want csv log
                    $(anchor_csv).append("<p>").append(csv_bean[0]).append("</p>");
                }
                if (anchor_result_prov_link) {
                    let ID=parsed[0]["ID"];
                    let prov_link = createProvLink(name, ID);
                    $(anchor_result_prov_link).html(prov_link);
                }
            }
            $(anchor_result_box).attr('received','true');
        }

        // Currently, the server does not support the csv format in the result
        if (true) {
            xhr.setRequestHeader("Accept", MEDIA_TYPE_APPLICATION_PROV_TEMPLATE_JSON);
        } else {
            xhr.setRequestHeader("Accept", MEDIA_TYPE_TEXT_CSV);
        }

        if (jsonSubmit) {
            xhr.setRequestHeader("Content-Type", MEDIA_TYPE_APPLICATION_PROV_TEMPLATE_JSON);
        } else {
            xhr.setRequestHeader("Content-Type", MEDIA_TYPE_TEXT_CSV);
        }

        console.log("submitService " + jsonSubmit);

        if (jsonSubmit) {
            xhr.send(json_data);
        } else {
            xhr.send(csv_data);
        }
    }

    function enactClear() {
        $(HTML_ANCHOR_ENACT_RESULT_BOX).html("");
        $(HTML_ANCHOR_ENACT_RESULT_PROV_LINK).html("");
    }


    function submitBrowse(b) {
        let url = "http://localhost:7072/ptl/provapi/templates/records"
        console.log("submitBrowse " + url)
        let id = '#browser_list'

        $.ajax({
            type: "GET",
            url: url,
            dataType: "text",
            success: function (contents) {
                var data = $.csv.toArrays(contents);
                data.shift()
                var columns = data[0];
                var titles = $.map(columns, function (column) {
                    return {"title": column}
                })
                console.log(titles)
                data.shift()

                $(id).DataTable({
                    destroy: true,
                    "data": data,
                    "columns": titles,
                    order: [[1, 'desc']]
                });
            }
        });
    }


    let imageNameMapper = {
        "plead_transforming": "plead-transforming",
        "plead_filtering": "plead-filtering",
        "plead_training": "plead-training",
        "plead_validating": "plead-validating",
        "plead_approving": "plead-approving",
        "plead_splitting": "plead-splitting"
    };

    const tm=new TemplateManager(logger,SCHEMA_URL,DOC_URL,profile);
    tm.setCsvResult(HTML_ANCHOR_CSV_RESULT);
    tm.setJsonResult(HTML_ANCHOR_JSON_RESULT);
    tm.setImageUrlPrefix('${image.url.prefix}');
    tm.setImageLocation(HTML_ANCHOR_DOCUMENTATION_IMAGE);
    tm.setFilenameConverter(imageNameMapper)
    tm.createDropdownForPlayground(HTML_ANCHOR_TEMPLATE_DROPDOWN_COMPOSER, "tm");
    tm.createDropdownForDocumentation(HTML_ANCHOR_TEMPLATE_DROPDOWN_DOCUMENTATOIN, "tm");


</script>

<script src="${service.context}/webjars/bootstrap/${webjars.bootstrap.version}/js/bootstrap.min.js"></script>
<script src="${service.context}/webjars/bootstrap/${webjars.bootstrap.version}/js/dropdown.js"></script>
<script src="${service.context}/webjars/bootstrap/${webjars.bootstrap.version}/js/tab.js"></script>
<script>
    $('.dropdown-toggle').dropdown();
</script>
</body>
</html>