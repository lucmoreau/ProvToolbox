/**
 * ProvToolbox
 *
 * Once the jar file MODULE.VERSION has been generated by the template compiler,
 * it can be exposed as a webjar resource
 *
 *
 * The followin file can be imported as
 * <script type="text/javascript" src="/webjars/MODULE/VERSION/js/FormManager.js"></script>
 *
 * It can then be used as follows:
 *
 *
 *
 * let schemaUrl = "http://domainname/webjars/MODULE/VERSION/schema/schema.json";
 * const logger = new your.application.path.Logger();

 * const fm = new FormManager(logger, schemaUrl);
 * fm.createDropdown("#template-dropdown", "fm");
 *
 */



class FormManager {
    constructor(logger, schemaUrl) {
        this.logger = logger;
        this.schemaUrl = schemaUrl;
        this.builders = logger.getBuilders();
        this.names = 0;
        this.jsonSchema = 0;
        this.builderTable = this.initializeBuilderTable();
        this.loadSchemaFile();

    }

    populateBean(template, values) {
        var builder = this.builderTable[template];
        var bean = builder.newBean();
        $.each(values, function (k, v) {
            bean[k] = v;
        });
        console.log(bean);
        var csv = bean.invoke(builder);
        return csv;
    }

    createFormConfig(jsonSchema, template) {
        const myself = this;
        let schemaDef = jsonSchema.definitions[template]
        let required = [];
        $.each(schemaDef.required, function (i, s) {
            required.push(s);
        });
        required.push({
            "type": "submit",
            "title": "Submit"
        });
        console.log(schemaDef);
        console.log(required)
        var config = {};
        config.schema = schemaDef;
        config.form = required;
        config.onSubmit = function (errors, values) {
            console.log(values);
            var csv = myself.populateBean(template, values);
            console.log(csv);
            $('#result').html('<p>' + csv + '</p>');
        };
        config.params = {
            "fieldHtmlClass": "input-small"
        };
        return config;
    }

    createDropdownMenu(id, fm, keys) {
        const menu = $('<ul>').addClass("dropdown-menu").attr('id', id)
        $.each(keys, function (i, k) {
            const item = $('<a>').addClass("dropdown-item").attr("href", "#").html(k).attr('onclick', fm + '.updateForm("' + k + '")');
            menu.append($('<li>').append(item));
        });
        $('#template-dropdown').append(menu);
    }


    updateForm(key) {
        console.log("update form " + key)
        console.log(this.jsonSchema)
        var config = this.createFormConfig(this.jsonSchema, key);
        $('form').jsonForm(config);
    }

    clearForm() {
        $('form').html("");
    }


    initializeBuilderTable() {
        const names = [];
        const table = {};
        $.each(this.builders, function (i, f) {
            names.push(f.getName());
            table[f.getName()] = f;
        });
        this.names = names;
        return table;
    };


    loadSchemaFile() {
        const myself = this;
        $.getJSON(schemaUrl,
            function (schemaFile) {
                myself.updateSchemaFile(schemaFile);

                console.log(myself.jsonSchema);
                console.log(myself.names);
            });
    };

    updateSchemaFile(file) {
        this.jsonSchema = file;
    }

    createDropdown(id, fm) {
        this.createDropdownMenu(id, fm, this.names);
    }
}

